<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Call Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        input, button { margin: 5px; padding: 8px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; border-radius: 3px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        video { width: 300px; height: 225px; background: #000; margin: 10px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 3px; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>WebRTC Call Test Client</h1>
    
    <div class="section">
        <h3>Configuration</h3>
        <input type="text" id="userId" placeholder="@user:localhost" value="@test1:localhost">
        <input type="text" id="roomId" placeholder="!room:localhost" value="!test:localhost">
        <input type="text" id="accessToken" placeholder="Matrix Access Token">
        <select id="callType">
            <option value="video">Video Call</option>
            <option value="voice">Voice Call</option>
        </select>
    </div>

    <div class="section">
        <h3>Call Controls</h3>
        <button onclick="initiateCall()">Initiate Call</button>
        <button onclick="answerCall()" id="answerBtn" disabled>Answer Call</button>
        <button onclick="rejectCall()" id="rejectBtn" disabled>Reject Call</button>
        <button onclick="endCall()" id="endBtn" disabled>End Call</button>
        <br>
        <button onclick="toggleAudio()" id="audioBtn" disabled>Toggle Audio</button>
        <button onclick="toggleVideo()" id="videoBtn" disabled>Toggle Video</button>
        <br>
        <input type="text" id="callIdInput" placeholder="Call ID (for answering)">
    </div>

    <div class="section">
        <h3>Status</h3>
        <div id="status"></div>
    </div>

    <div class="section">
        <h3>Video Streams</h3>
        <div>
            <video id="localVideo" autoplay muted playsinline></video>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket;
        let currentCallId;
        let peerConnection;
        let localStream;
        let audioEnabled = true;
        let videoEnabled = true;

        const API_BASE = window.location.origin;
        const iceServers = [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
        ];

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function connectWebSocket() {
            if (socket?.connected) return;
            
            socket = io(API_BASE);
            
            socket.on('connect', () => {
                showStatus('WebSocket connected', 'success');
            });

            socket.on('user-joined', ({ userId }) => {
                showStatus(`${userId} joined the call`, 'info');
            });

            socket.on('webrtc-offer', async ({ offer, fromUserId }) => {
                showStatus(`Received offer from ${fromUserId}`, 'info');
                await handleOffer(offer, fromUserId);
            });

            socket.on('webrtc-answer', async ({ answer, fromUserId }) => {
                showStatus(`Received answer from ${fromUserId}`, 'info');
                await peerConnection.setRemoteDescription(answer);
            });

            socket.on('ice-candidate', async ({ candidate, fromUserId }) => {
                if (candidate) {
                    await peerConnection.addIceCandidate(candidate);
                }
            });

            socket.on('user-left', ({ userId }) => {
                showStatus(`${userId} left the call`, 'info');
            });
        }

        async function getLocalStream() {
            const callType = document.getElementById('callType').value;
            const constraints = {
                audio: true,
                video: callType === 'video'
            };
            
            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            document.getElementById('localVideo').srcObject = localStream;
            return localStream;
        }

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection({ iceServers });

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', {
                        callId: currentCallId,
                        candidate: event.candidate,
                        targetUserId: 'all'
                    });
                }
            };

            peerConnection.ontrack = (event) => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
                showStatus('Remote stream received', 'success');
            };

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
        }

        async function initiateCall() {
            try {
                const userId = document.getElementById('userId').value;
                const roomId = document.getElementById('roomId').value;
                const accessToken = document.getElementById('accessToken').value;
                const callType = document.getElementById('callType').value;

                showStatus('Initiating call...', 'info');

                const response = await fetch(`${API_BASE}/api/calls/initiate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, roomId, accessToken, callType })
                });

                const data = await response.json();
                currentCallId = data.callId;
                document.getElementById('callIdInput').value = currentCallId;

                showStatus(`Call initiated: ${currentCallId}`, 'success');

                connectWebSocket();
                await getLocalStream();
                createPeerConnection();

                socket.emit('join-call', { callId: currentCallId, userId });

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                socket.emit('webrtc-offer', {
                    callId: currentCallId,
                    offer: offer,
                    targetUserId: 'all'
                });

                document.getElementById('endBtn').disabled = false;
                document.getElementById('audioBtn').disabled = false;
                document.getElementById('videoBtn').disabled = false;
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function answerCall() {
            try {
                const userId = document.getElementById('userId').value;
                const accessToken = document.getElementById('accessToken').value;
                currentCallId = document.getElementById('callIdInput').value;

                showStatus('Answering call...', 'info');

                const response = await fetch(`${API_BASE}/api/calls/${currentCallId}/answer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, accessToken })
                });

                const data = await response.json();
                showStatus(`Call answered: ${currentCallId}`, 'success');

                connectWebSocket();
                await getLocalStream();
                createPeerConnection();

                socket.emit('join-call', { callId: currentCallId, userId });

                document.getElementById('endBtn').disabled = false;
                document.getElementById('audioBtn').disabled = false;
                document.getElementById('videoBtn').disabled = false;
                document.getElementById('answerBtn').disabled = true;
                document.getElementById('rejectBtn').disabled = true;
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function handleOffer(offer, fromUserId) {
            await peerConnection.setRemoteDescription(offer);
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            socket.emit('webrtc-answer', {
                callId: currentCallId,
                answer: answer,
                targetUserId: fromUserId
            });
        }

        async function rejectCall() {
            try {
                const userId = document.getElementById('userId').value;
                const accessToken = document.getElementById('accessToken').value;
                currentCallId = document.getElementById('callIdInput').value;

                await fetch(`${API_BASE}/api/calls/${currentCallId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, accessToken })
                });

                showStatus('Call rejected', 'info');
                cleanup();
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function endCall() {
            try {
                const userId = document.getElementById('userId').value;
                const accessToken = document.getElementById('accessToken').value;

                await fetch(`${API_BASE}/api/calls/${currentCallId}/end`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, accessToken })
                });

                socket.emit('leave-call', { callId: currentCallId });
                showStatus('Call ended', 'info');
                cleanup();
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function toggleAudio() {
            audioEnabled = !audioEnabled;
            localStream.getAudioTracks()[0].enabled = audioEnabled;

            await fetch(`${API_BASE}/api/calls/${currentCallId}/toggle-audio`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: document.getElementById('userId').value,
                    enabled: audioEnabled
                })
            });

            socket.emit('toggle-audio', { callId: currentCallId, enabled: audioEnabled });
            showStatus(`Audio ${audioEnabled ? 'enabled' : 'disabled'}`, 'info');
        }

        async function toggleVideo() {
            videoEnabled = !videoEnabled;
            localStream.getVideoTracks()[0].enabled = videoEnabled;

            await fetch(`${API_BASE}/api/calls/${currentCallId}/toggle-video`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: document.getElementById('userId').value,
                    enabled: videoEnabled
                })
            });

            socket.emit('toggle-video', { callId: currentCallId, enabled: videoEnabled });
            showStatus(`Video ${videoEnabled ? 'enabled' : 'disabled'}`, 'info');
        }

        function cleanup() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
            }
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('endBtn').disabled = true;
            document.getElementById('audioBtn').disabled = true;
            document.getElementById('videoBtn').disabled = true;
        }

        // Enable answer/reject buttons when call ID is entered
        document.getElementById('callIdInput').addEventListener('input', (e) => {
            const hasCallId = e.target.value.length > 0;
            document.getElementById('answerBtn').disabled = !hasCallId;
            document.getElementById('rejectBtn').disabled = !hasCallId;
        });
    </script>
</body>
</html>
